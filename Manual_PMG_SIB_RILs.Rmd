---
title: "Probabilities of multilocus genotypes in SIB recombinant inbred lines"
output: 
  pdf_document: 
    number_sections: yes
    citation_package: natbib
author: "Kamel Jebreen, Marianyela Petrizzelli, Olivier C. Martin"
in_header: mystyles.sty
theme: united
urlcolor: blue
linkcolor: cyan
bibliography: RIL.bib
biblio-style: apalike
number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
Set the working directory to the emplacement of the source file "PMG_SIB_RILs.R" and load it to the working environment. You can download the "PMG_SIB_RILs.R" file from <https://github.com/olivier-c-martin/PMG_SIB_RILs.git>, 

```{r  eval=FALSE}
  setwd("the directory")
  source("PMG_SIB_RILs.R.R")
```

Then load the required packages:

```{r}
  library(eply)
  library(rlist)
  library(rmarkdown)
```

```{r, include = FALSE}
  source('~/Documents/SVmapNew/MarianyelaProject/R/PMGISRILOM/PMG_SIB_RILs.R')
```

# Input
This code just needs as inputs the number of loci  L_loci and the recombination rates for successive intervals which is a vector of length L_loci - 1. For example, for L_loci=3

```{r}
  L_loci = 3
  recRates = c(0.4, 0.2)
```

# The listing of variables used (all $Q$'s and all non-equivalent $Q$'s)
To gain time we find the list of inheritance indices (all $Q$'s) that contribute in the system (till L_loci =10)

```{r, eval=FALSE}
  allQs = list.load("allVarTillL=10.rds")
  allvpForallup = list.load("allContrVarTillL=10.rds")
  
  nonEquivalentQs = allQs[[L_loci]]$symQs
  allQsMappedToNonEquivalent = allQs[[L_loci]]$nonsymQs
  allvpForallup = allvpForallup[[L_loci]]
```

Or you can reconstruct all these objects by direct calculation:

```{r}
  allQs = systemVar(L_loci) 
```


Note that the non-equivalent $Q$'s are
```{r}
  nonEquivalentQs = allQs$symQs
```

and the $4^L$ $Q$'s are mapped to the non-equivalent ones via

```{r}
  allQsMappedToNonEquivalent = allQs$indicesAllQs
```

Note that the first equation of the linear system is given by the fact that $\sum(Q's) = 1$

```{r}
  multiplicityQs = table(allQsMappedToNonEquivalent)
```

This means that 

```{r, echo=FALSE}
  cat(paste(paste(as.vector(multiplicityQs),"Q(", names(multiplicityQs),")", collapse = "+", sep = ""),"=1", sep = ""))
```

Now determine the list of all $v^\prime$ given the $u^\prime$ to be used to construct the self-consistent equations. 

```{r}
  allvpForallup = allvprimeForEachuprime(nonEquivalentQs)
```

# Find the system AQ = B

The analytic expressions of the system of linear equations to be solved are
```{r}
    analyticEquations = twoWayRILsib(L_loci, nonEquivalentQs, allQsMappedToNonEquivalent, allvpForallup, multiplicityQs)  

```

Hence, the matrix of equations is 

```{r}
  Amatrix = analyticEquations$A
  Amatrix[1:3,1:2]
```

and, the coefficient matrix is 

```{r}
  Bvector = analyticEquations$B
  Bvector[1:3]
```

Now substitute the numerical values of the recombination rates
```{r}
  numericAmatrix = evalMatrix(A = Amatrix, recRates = recRates)
```
For example, 
```{r}
  numericAmatrix[1:3,1:2]
```

Hence, the solution for the $N_Q(L)$ unknown (non-equivalent) $Q$'s is

```{r}
  solution = solve(numericAmatrix, Bvector) 
  names(solution) = nonEquivalentQs
  solution
```

This means, 

```{r, echo=FALSE}
cat(" Q(0,0,0) = ", solution[1], ",", "Q(0,0,1) = ", solution[2], ",", "Q(0,0,2) = ", solution[3], "\n",
     "Q(0,1,0) = ", solution[4], ",", "Q(0,1,1) = ", solution[5], ",", "Q(0,1,2) = ", solution[6], "\n",        "Q(0,2,0) = ", solution[7], ",", "Q(0,2,1) = ", solution[8], ",",  "Q(0,2,2) = ", solution[9], "\n",
    "Q(0,2,3) = ", solution[10])
```

# Use the $Q$'s to compute the RIL
We go from the $Q$'s (RIL IBD probabilities) to RIL multilocus genotype probabilities by computing the $2^L$ probabilities of multilocus SIB RIL genotypes

```{r}
  allProbabilitiesOfRilGenotypes= QsToGenotypeProbabilities(L_loci, solution)
  allProbabilitiesOfRilGenotypes
```

Note that the sum of these probabilities should be one

```{r}
  sumAllProbabilities = sum(allProbabilitiesOfRilGenotypes)
  sumAllProbabilities
```

    
For more details see [@kjebreen_2019].
 
 
# Bibliography
